<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <title>Tutorial Demo</title>
</head>
<style>
    .g6-tooltip {
        border-radius: 6px;
        font-size: 12px;
        color: #fff;
        background-color: #000;
        padding: 2px 8px;
        text-align: center;
    }
</style>
<body>
/* 图的画布容器 */
<div id="container" style="border: 1px  solid black"></div>

/* 引入 G6 */
<!--<script src="https://gw.alipayobjects.com/os/antv/pkg/_antv.g6-3.7.1/dist/g6.min.js"></script>-->
<script src="g6.min.js"></script>

<script>
    const data = {
        nodes: [
            {
                id: '1',
                dataType: 'alps',
                name: 'alps_file1',
                conf: [
                    {
                        label: 'conf',
                        value: 'pai_graph.conf',
                    },
                    {
                        label: 'dot',
                        value: 'pai_graph.dot',
                    },
                    {
                        label: 'init',
                        value: 'init.rc',
                    },
                ],
                title: 'node1',
                error: false,
                nodeType: 'a',
                nodeLevel: 3,
                panels: [
                    { title: '成功率', value: '11%' },
                    { title: '耗时', value: '111' },
                    { title: '错误数', value: '111' },
                ],
                collapse: true,
            },
            {
                id: '2',
                dataType: 'alps',
                name: 'alps_file2',
                conf: [
                    {
                        label: 'conf',
                        value: 'pai_graph.conf',
                    },
                    {
                        label: 'dot',
                        value: 'pai_graph.dot',
                    },
                    {
                        label: 'init',
                        value: 'init.rc',
                    },
                ],
                title: 'node2',
                error: false,
                nodeType: 'a',
                nodeLevel: 3,
                panels: [
                    { title: '成功率', value: '11%' },
                    { title: '耗时', value: '111' },
                    { title: '错误数', value: '111' },
                ],
                collapse: true,
            },
            {
                id: '3',
                dataType: 'alps',
                name: 'alps_file3',
                conf: [
                    {
                        label: 'conf',
                        value: 'pai_graph.conf',
                    },
                    {
                        label: 'dot',
                        value: 'pai_graph.dot',
                    },
                    {
                        label: 'init',
                        value: 'init.rc',
                    },
                ],
                title: 'node3',
                error: false,
                nodeType: 'a',
                nodeLevel: 3,
                panels: [
                    { title: '成功率', value: '11%' },
                    { title: '耗时', value: '111' },
                    { title: '错误数', value: '111' },
                ],
                collapse: true,
            },
            {
                id: '4',
                dataType: 'sql',
                name: 'sql_file1',
                conf: [
                    {
                        label: 'conf',
                        value: 'pai_graph.conf',
                    },
                    {
                        label: 'dot',
                        value: 'pai_graph.dot',
                    },
                    {
                        label: 'init',
                        value: 'init.rc',
                    },
                ],
                title: 'node4',
                error: false,
                nodeType: 'a',
                nodeLevel: 3,
                panels: [
                    { title: '成功率', value: '11%' },
                    { title: '耗时', value: '111' },
                    { title: '错误数', value: '111' },
                ],
                collapse: true,
            },
            {
                id: '5',
                dataType: 'sql',
                name: 'sql_file2',
                conf: [
                    {
                        label: 'conf',
                        value: 'pai_graph.conf',
                    },
                    {
                        label: 'dot',
                        value: 'pai_graph.dot',
                    },
                    {
                        label: 'init',
                        value: 'init.rc',
                    },
                ],
                title: 'node5',
                error: false,
                nodeType: 'a',
                nodeLevel: 3,
                panels: [
                    { title: '成功率', value: '11%' },
                    { title: '耗时', value: '111' },
                    { title: '错误数', value: '111' },
                ],
                collapse: true,
            },
            {
                id: '6',
                dataType: 'feature_etl',
                name: 'feature_etl_1',
                conf: [
                    {
                        label: 'conf',
                        value: 'pai_graph.conf',
                    },
                    {
                        label: 'dot',
                        value: 'pai_graph.dot',
                    },
                    {
                        label: 'init',
                        value: 'init.rc',
                    },
                ],
                title: 'node6',
                error: false,
                nodeType: 'a',
                nodeLevel: 3,
                panels: [
                    { title: '成功率', value: '11%' },
                    { title: '耗时', value: '111' },
                    { title: '错误数', value: '111' },
                ],
                collapse: true,
            },
            {
                id: '7',
                dataType: 'feature_etl',
                name: 'feature_etl_1',
                conf: [
                    {
                        label: 'conf',
                        value: 'pai_graph.conf',
                    },
                    {
                        label: 'dot',
                        value: 'pai_graph.dot',
                    },
                    {
                        label: 'init',
                        value: 'init.rc',
                    },
                ],
                title: 'node7',
                error: false,
                nodeType: 'a',
                nodeLevel: 3,
                panels: [
                    { title: '成功率', value: '11%' },
                    { title: '耗时', value: '111' },
                    { title: '错误数', value: '111' },
                ],
                collapse: true,
            },
            {
                id: '8',
                dataType: 'feature_extractor',
                name: 'feature_extractor',
                conf: [
                    {
                        label: 'conf',
                        value: 'pai_graph.conf',
                    },
                    {
                        label: 'dot',
                        value: 'pai_graph.dot',
                    },
                    {
                        label: 'init',
                        value: 'init.rc',
                    },
                ],
                title: 'node8',
                error: false,
                nodeType: 'a',
                nodeLevel: 3,
                panels: [
                    { title: '成功率', value: '11%' },
                    { title: '耗时', value: '111' },
                    { title: '错误数', value: '111' },
                ],
                collapse: true,
            },
            {
                id: '9',
                dataType: 'feature_extractor',
                name: 'feature_extractor',
                conf: [
                    {
                        label: 'conf',
                        value: 'pai_graph.conf',
                    },
                    {
                        label: 'dot',
                        value: 'pai_graph.dot',
                    },
                    {
                        label: 'init',
                        value: 'init.rc',
                    },
                ],
                title: 'node9',
                error: false,
                nodeType: 'a',
                nodeLevel: 3,
                panels: [
                    { title: '成功率', value: '11%' },
                    { title: '耗时', value: '111' },
                    { title: '错误数', value: '111' },
                ],
                collapse: true,
            },
        ],
        edges: [
            {
                source: '1',
                target: '2',
            },
            {
                source: '1',
                target: '5',
            },
            {
                source: '1',
                target: '9',
            },
            {
                source: '9',
                target: '4',
            },
            {
                source: '1',
                target: '3',
            },

            {
                source: '2',
                target: '4',
            },
            {
                source: '3',
                target: '4',
            },
            {
                source: '4',
                target: '5',
            },
            {
                source: '5',
                target: '6',
            },
            {
                source: '6',
                target: '7',
            },
            {
                source: '6',
                target: '8',
            },
        ],
    };


    const ICON_MAP = {
        // a: 'https://gw.alipayobjects.com/mdn/rms_8fd2eb/afts/img/A*0HC-SawWYUoAAAAAAAAAAABkARQnAQ',
        // b: 'https://gw.alipayobjects.com/mdn/rms_8fd2eb/afts/img/A*sxK0RJ1UhNkAAAAAAAAAAABkARQnAQ',
        a: 'image/nodeicon.png',
        b: 'image/nodeicon.png',
    };


    G6.registerNode(
        'card-node',
        {
            drawShape: function drawShape(cfg, group) {
                const color = cfg.error ? '#F4664A' : '#30BF78';
                const r = 6;
                const shape = group.addShape('rect', {
                    attrs: {
                        x: 0,
                        y: 0,
                        width: 200,
                        height: 60,
                        stroke: color,
                        radius: r,
                    },
                    name: 'main-box',
                    draggable: true,
                });

                group.addShape('rect', {
                    attrs: {
                        x: 0,
                        y: 0,
                        width: 200,
                        height: 20,
                        fill: color,
                        radius: [r, r, 0, 0],
                    },
                    name: 'title-box',
                    draggable: true,
                });

                // left icon
                group.addShape('image', {
                    attrs: {
                        x: 4,
                        y: 2,
                        height: 16,
                        width: 16,
                        cursor: 'pointer',
                        img: ICON_MAP[cfg.nodeType || 'app'],
                    },
                    name: 'node-icon',
                });

                // title text
                group.addShape('text', {
                    attrs: {
                        textBaseline: 'top',
                        y: 3,
                        fontSize: 16,
                        x: 24,
                        lineHeight: 20,
                        text: cfg.title,
                        fill: '#fff',
                    },
                    name: 'title',
                });

/*
                if (cfg.nodeLevel > 0) {
                    group.addShape('marker', {
                        attrs: {
                            x: 184,
                            y: 30,
                            r: 6,
                            cursor: 'pointer',
                            symbol: cfg.collapse ? G6.Marker.expand : G6.Marker.collapse,
                            stroke: '#666',
                            lineWidth: 1,
                        },
                        name: 'collapse-icon',
                    });
                }
*/

                // The content list
                cfg.panels.forEach((item, index) => {
                    // name text
                    group.addShape('text', {
                        attrs: {
                            textBaseline: 'top',
                            y: 25,
                            x: 24 + index * 60,
                            lineHeight: 20,
                            text: item.title,
                            fill: 'rgba(0,0,0, 0.4)',
                        },
                        name: `index-title-${index}`,
                    });

                    // value text
                    group.addShape('text', {
                        attrs: {
                            textBaseline: 'top',
                            y: 42,
                            x: 24 + index * 60,
                            lineHeight: 20,
                            text: item.value,
                            fill: '#595959',
                        },
                        name: `index-title-${index}`,
                    });
                });
                return shape;
            },
        },
        'single-node',
    );

    const container = document.getElementById('container');
    const width = container.scrollWidth;
    // const height = container.scrollHeight || 500;
    const height = container.scrollHeight || 800;
    const graph = new G6.Graph({
        container: 'container',
        width,
        height,
        // height:1800,
        layout: {
            type: 'dagre',
            // rankdir: 'LR',
            rankdir: 'TB',
            align: 'UL', /*节点对其方式　默认中间对齐*/
            nodesepFunc: (d) => {
                if (d.id === '3') {
                    return 90;
                }
                return 60;
            },
            ranksep: 30,
            // controlPoints: true,
            // workerEnabled: true,
        },
        defaultNode: {
            type: 'card-node',
            anchorPoints: [
                [0.5, 0],
                [0.5, 1],
                // [1, 0.5],
                // [0, 0.5],
            ],
        },
        defaultEdge: {
            type: 'polyline',
            style: {
                // radius: 10,
                // offset: 10,
                endArrow: true,
                lineWidth: 2,
                stroke: '#C2C8D5',
            },

        },
        nodeStateStyles: {
            selected: {
                stroke: '#d9d9d9',
                fill: '#5394ef',
            },
        },
        modes: {
            default: [
                'drag-canvas',
                'zoom-canvas',
                'click-select',
         /*       {
                    type: 'tooltip',
                    formatText(model) {
                        const cfg = model.conf;
                        const text = [];
                        cfg.forEach((row) => {
                            text.push(row.label + ':' + row.value + '<br>');
                        });
                        return text.join('\n');
                    },
                    offset: 30,
                },*/
            ],
        },
        fitView: true,
    });
    graph.data(data);
    graph.render();

    if (typeof window !== 'undefined')
        window.onresize = () => {
            if (!graph || graph.get('destroyed')) return;
            if (!container || !container.scrollWidth || !container.scrollHeight) return;
            graph.changeSize(container.scrollWidth, container.scrollHeight);
        };
</script>
</body>
</html>
